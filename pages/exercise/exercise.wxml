<!--pages/exercise/exercise.wxml-->
<view class="container">
  <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
  <view class="date-selector">
    <view class="date-nav">
      <button class="nav-btn" bindtap="changeDate" data-direction="prev">â€¹</button>
      <view class="date-display" bindtap="pickDate">
        <text class="date-text">{{selectedDate}}</text>
        <text class="date-desc">{{dateDesc}}</text>
      </view>
      <button class="nav-btn" bindtap="changeDate" data-direction="next">â€º</button>
    </view>
  </view>

  <!-- ä»Šæ—¥è¿åŠ¨ç»Ÿè®¡ -->
  <view class="card stats-card">
    <view class="stats-header">
      <text class="stats-title">ä»Šæ—¥è¿åŠ¨</text>
      <view class="achievement-badge" wx:if="{{hasAchievement}}">
        <text class="badge-text">ğŸ† è¾¾æ ‡</text>
      </view>
    </view>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-value">{{todayStats.duration}}</text>
        <text class="stat-label">è¿åŠ¨æ—¶é•¿</text>
        <text class="stat-unit">åˆ†é’Ÿ</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{todayStats.calories}}</text>
        <text class="stat-label">æ¶ˆè€—çƒ­é‡</text>
        <text class="stat-unit">kcal</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{todayStats.count}}</text>
        <text class="stat-label">è¿åŠ¨æ¬¡æ•°</text>
        <text class="stat-unit">æ¬¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{todayStats.steps}}</text>
        <text class="stat-label">æ­¥æ•°</text>
        <text class="stat-unit">æ­¥</text>
      </view>
    </view>
    
    <!-- ç›®æ ‡è¿›åº¦ -->
    <view class="goal-progress">
      <view class="progress-header">
        <text class="progress-label">ä»Šæ—¥ç›®æ ‡è¿›åº¦</text>
        <text class="progress-percent">{{goalProgress}}%</text>
      </view>
      <view class="progress-bar-container">
        <view class="progress-bar" style="width: {{goalProgress}}%"></view>
      </view>
      <text class="progress-goal">ç›®æ ‡: {{dailyGoal}}åˆ†é’Ÿ</text>
    </view>
  </view>

  <!-- å¿«æ·è¿åŠ¨é€‰æ‹© -->
  <view class="quick-exercise-section">
    <view class="section-header">
      <text class="section-title">å¿«æ·è¿åŠ¨</text>
      <text class="section-more" bindtap="viewAllExercises">æ›´å¤š ></text>
    </view>
    <scroll-view class="exercise-scroll" scroll-x="true">
      <view class="exercise-grid">
        <block wx:for="{{quickExercises}}" wx:key="id">
          <view class="exercise-item" bindtap="startExercise" data-exercise="{{item}}">
            <view class="exercise-icon">{{item.icon}}</view>
            <text class="exercise-name">{{item.name}}</text>
            <text class="exercise-met">{{item.met}} MET</text>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <!-- è¿åŠ¨è®¡æ—¶å™¨ -->
  <view class="timer-section" wx:if="{{currentExercise}}">
    <view class="card timer-card">
      <view class="timer-header">
        <text class="timer-title">{{currentExercise.name}}</text>
        <button class="stop-btn" bindtap="stopExercise">ç»“æŸ</button>
      </view>
      <view class="timer-display">
        <text class="timer-time">{{formatTime(elapsedTime)}}</text>
        <text class="timer-calories">å·²æ¶ˆè€— {{currentCalories}} kcal</text>
      </view>
      <view class="timer-controls">
        <button class="timer-btn {{isRunning ? 'pause' : 'start'}}" bindtap="toggleTimer">
          {{isRunning ? 'æš‚åœ' : 'å¼€å§‹'}}
        </button>
      </view>
    </view>
  </view>

  <!-- è¿åŠ¨è®°å½•åˆ—è¡¨ -->
  <view class="records-section">
    <view class="section-header">
      <text class="section-title">ä»Šæ—¥è®°å½•</text>
      <view class="view-toggle">
        <text class="toggle-item {{recordView === 'list' ? 'active' : ''}}" bindtap="switchRecordView" data-view="list">åˆ—è¡¨</text>
        <text class="toggle-item {{recordView === 'chart' ? 'active' : ''}}" bindtap="switchRecordView" data-view="chart">å›¾è¡¨</text>
      </view>
    </view>
    
    <!-- åˆ—è¡¨è§†å›¾ -->
    <view class="records-list" wx:if="{{recordView === 'list'}}">
      <block wx:for="{{exerciseRecords}}" wx:key="id">
        <view class="record-item">
          <view class="record-icon">{{item.icon}}</view>
          <view class="record-info">
            <text class="record-name">{{item.exerciseName}}</text>
            <text class="record-time">{{item.startTime}} - {{item.endTime}}</text>
            <view class="record-details">
              <text class="detail-item">â±ï¸ {{item.duration}}åˆ†é’Ÿ</text>
              <text class="detail-item">ğŸ”¥ {{item.caloriesBurned}}kcal</text>
              <text class="detail-item" wx:if="{{item.distance}}">ğŸ“ {{item.distance}}km</text>
              <text class="detail-item" wx:if="{{item.steps}}">ğŸ‘£ {{item.steps}}æ­¥</text>
            </view>
          </view>
          <view class="record-actions">
            <button class="action-btn edit" bindtap="editRecord" data-id="{{item.id}}">âœï¸</button>
            <button class="action-btn delete" bindtap="deleteRecord" data-id="{{item.id}}">ğŸ—‘ï¸</button>
          </view>
        </view>
      </block>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-records" wx:if="{{exerciseRecords.length === 0}}">
        <view class="empty-icon">ğŸƒ</view>
        <text class="empty-text">ä»Šæ—¥è¿˜æ²¡æœ‰è¿åŠ¨è®°å½•</text>
        <text class="empty-hint">é€‰æ‹©ä¸€é¡¹è¿åŠ¨å¼€å§‹å§ï¼</text>
      </view>
    </view>
    
    <!-- å›¾è¡¨è§†å›¾ -->
    <view class="records-chart" wx:if="{{recordView === 'chart'}}">
      <view class="chart-container">
        <ec-canvas id="exercise-chart" canvas-id="exercise-chart" ec="{{ exerciseChart }}"></ec-canvas>
      </view>
    </view>
  </view>

  <!-- è¿åŠ¨å†å²ç»Ÿè®¡ -->
  <view class="history-stats">
    <view class="section-title">æœ¬å‘¨ç»Ÿè®¡</view>
    <view class="weekly-chart">
      <view class="chart-container">
        <ec-canvas id="weekly-chart" canvas-id="weekly-chart" ec="{{ weeklyChart }}"></ec-canvas>
      </view>
    </view>
  </view>

  <!-- æµ®åŠ¨æ·»åŠ æŒ‰é’® -->
  <view class="fab-container">
    <button class="fab-main {{fabExpanded ? 'expanded' : ''}}" bindtap="toggleFab">
      <text class="fab-icon">{{fabExpanded ? 'Ã—' : '+'}}</text>
    </button>
    
    <view class="fab-options {{fabExpanded ? 'show' : 'hide'}}">
      <button class="fab-option" bindtap="quickStart">
        <text class="option-icon">âš¡</text>
        <text class="option-text">å¿«é€Ÿå¼€å§‹</text>
      </button>
      <button class="fab-option" bindtap="customExercise">
        <text class="option-icon">âœï¸</text>
        <text class="option-text">è‡ªå®šä¹‰è¿åŠ¨</text>
      </button>
      <button class="fab-option" bindtap="importFromHealth">
        <text class="option-icon">ğŸ“±</text>
        <text class="option-text">å¯¼å…¥æ•°æ®</text>
      </button>
    </view>
  </view>

  <!-- è¿åŠ¨è¯¦æƒ…å¼¹çª— -->
  <view class="exercise-modal {{showExerciseModal ? 'show' : 'hide'}}" catchtouchmove="true">
    <view class="modal-backdrop" bindtap="closeExerciseModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{selectedExercise.name}}</text>
        <button class="modal-close" bindtap="closeExerciseModal">Ã—</button>
      </view>
      <view class="modal-body">
        <view class="exercise-info">
          <view class="info-item">
            <text class="info-label">è¿åŠ¨å¼ºåº¦</text>
            <text class="info-value">{{selectedExercise.intensity}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">æ¶ˆè€—çƒ­é‡</text>
            <text class="info-value">{{selectedExercise.caloriesPerMin}} kcal/åˆ†é’Ÿ</text>
          </view>
          <view class="info-item">
            <text class="info-label">å»ºè®®æ—¶é•¿</text>
            <text class="info-value">{{selectedExercise.recommendedDuration}} åˆ†é’Ÿ</text>
          </view>
        </view>
        
        <view class="duration-input">
          <text class="input-label">é¢„è®¡è¿åŠ¨æ—¶é•¿</text>
          <view class="input-row">
            <button class="duration-btn" bindtap="changeDuration" data-change="-5">-5</button>
            <input class="duration-value" type="number" value="{{plannedDuration}}" bindinput="onDurationInput" />
            <text class="duration-unit">åˆ†é’Ÿ</text>
            <button class="duration-btn" bindtap="changeDuration" data-change="5">+5</button>
          </view>
          <text class="estimated-calories">é¢„è®¡æ¶ˆè€— {{estimatedCalories}} kcal</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeExerciseModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="confirmStartExercise">å¼€å§‹è¿åŠ¨</button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>