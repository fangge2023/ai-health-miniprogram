<!--pages/food-search/food-search.wxml-->
<view class="container">
  <!-- æœç´¢åŒºåŸŸ -->
  <view class="search-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <input 
          class="search-input" 
          placeholder="è¾“å…¥é£Ÿç‰©åç§°ã€å“ç‰Œæˆ–æ¡ç " 
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="searchFood"
          focus="{{searchFocus}}"
        />
        <view class="search-icon" bindtap="searchFood">ğŸ”</view>
      </view>
      <button class="scan-btn" bindtap="scanBarcode">ğŸ“·</button>
    </view>
    
    <!-- æœç´¢å»ºè®® -->
    <view class="search-suggestions" wx:if="{{searchSuggestions.length > 0 && searchKeyword}}">
      <scroll-view class="suggestions-scroll" scroll-x="true">
        <view class="suggestions-list">
          <block wx:for="{{searchSuggestions}}" wx:key="*this">
            <view class="suggestion-item" bindtap="selectSuggestion" data-suggestion="{{item}}">
              {{item}}
            </view>
          </block>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- åˆ†ç±»æ ‡ç­¾ -->
  <view class="category-section" wx:if="{{!searchKeyword}}">
    <scroll-view class="category-scroll" scroll-x="true">
      <view class="category-list">
        <view class="category-item {{selectedCategory === 'all' ? 'active' : ''}}" bindtap="selectCategory" data-category="all">
          ğŸ½ï¸ å…¨éƒ¨
        </view>
        <block wx:for="{{categories}}" wx:key="id">
          <view class="category-item {{selectedCategory === item.id ? 'active' : ''}}" bindtap="selectCategory" data-category="{{item.id}}">
            {{item.icon}} {{item.name}}
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢ç»“æœ -->
  <view class="search-results" wx:if="{{searchKeyword && searchResults.length > 0}}">
    <view class="results-header">
      <text class="results-count">æ‰¾åˆ° {{searchResults.length}} ä¸ªç»“æœ</text>
      <view class="sort-options">
        <text class="sort-item {{sortBy === 'relevance' ? 'active' : ''}}" bindtap="changeSortBy" data-sort="relevance">ç›¸å…³åº¦</text>
        <text class="sort-item {{sortBy === 'calories' ? 'active' : ''}}" bindtap="changeSortBy" data-sort="calories">çƒ­é‡</text>
        <text class="sort-item {{sortBy === 'popularity' ? 'active' : ''}}" bindtap="changeSortBy" data-sort="popularity">çƒ­é—¨</text>
      </view>
    </view>
    
    <view class="food-list">
      <block wx:for="{{searchResults}}" wx:key="id">
        <view class="food-item" bindtap="selectFood" data-food="{{item}}">
          <image class="food-image" src="{{item.image || '/images/default-food.png'}}" />
          <view class="food-info">
            <text class="food-name">{{item.name}}</text>
            <text class="food-brand" wx:if="{{item.brand}}">{{item.brand}}</text>
            <view class="food-nutrition">
              <text class="nutrition-item calories">{{item.calories}} kcal</text>
              <text class="nutrition-item protein">è›‹ç™½ {{item.protein}}g</text>
              <text class="nutrition-item carbs">ç¢³æ°´ {{item.carbs}}g</text>
              <text class="nutrition-item fat">è„‚è‚ª {{item.fat}}g</text>
            </view>
            <view class="food-tags" wx:if="{{item.tags && item.tags.length > 0}}">
              <block wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">
                <text class="food-tag">{{tag}}</text>
              </block>
            </view>
          </view>
          <view class="food-action">
            <text class="add-text">æ·»åŠ </text>
          </view>
        </view>
      </block>
    </view>
    
    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore}}">
      <button class="load-more-btn" bindtap="loadMore" loading="{{loadingMore}}">
        {{loadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}
      </button>
    </view>
  </view>

  <!-- çƒ­é—¨é£Ÿç‰© -->
  <view class="popular-foods" wx:if="{{!searchKeyword}}">
    <view class="section-header">
      <text class="section-title">çƒ­é—¨é£Ÿç‰©</text>
      <text class="section-more" bindtap="viewAllPopular">æŸ¥çœ‹å…¨éƒ¨ ></text>
    </view>
    <view class="food-grid">
      <block wx:for="{{popularFoods}}" wx:key="id">
        <view class="popular-food-item" bindtap="selectFood" data-food="{{item}}">
          <image class="popular-food-image" src="{{item.image || '/images/default-food.png'}}" />
          <view class="popular-food-info">
            <text class="popular-food-name">{{item.name}}</text>
            <text class="popular-food-calories">{{item.calories}} kcal</text>
            <view class="popular-food-rating">
              <block wx:for="{{5}}" wx:for-index="starIndex" wx:key="*this">
                <text class="star {{starIndex < item.rating ? 'filled' : ''}}">â˜…</text>
              </block>
              <text class="rating-text">({{item.searchCount || 0}})</text>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- æœ€è¿‘æœç´¢ -->
  <view class="recent-searches" wx:if="{{!searchKeyword && recentSearches.length > 0}}">
    <view class="section-header">
      <text class="section-title">æœ€è¿‘æœç´¢</text>
      <text class="clear-recent" bindtap="clearRecentSearches">æ¸…ç©º</text>
    </view>
    <view class="recent-list">
      <block wx:for="{{recentSearches}}" wx:key="*this">
        <view class="recent-item" bindtap="searchRecent" data-keyword="{{item}}">
          <text class="recent-text">{{item}}</text>
          <view class="recent-time">ğŸ•°ï¸</view>
        </view>
      </block>
    </view>
  </view>

  <!-- é£Ÿç‰©è¯¦æƒ…å¼¹çª— -->
  <view class="food-detail-modal {{showFoodDetail ? 'show' : 'hide'}}" catchtouchmove="true">
    <view class="modal-backdrop" bindtap="closeFoodDetail"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{selectedFood.name}}</text>
        <button class="modal-close" bindtap="closeFoodDetail">Ã—</button>
      </view>
      
      <view class="modal-body">
        <view class="food-detail-image">
          <image src="{{selectedFood.image || '/images/default-food.png'}}" />
        </view>
        
        <view class="nutrition-detail">
          <view class="portion-selector">
            <text class="portion-label">ä»½é‡é€‰æ‹©</text>
            <view class="portion-input">
              <button class="portion-btn" bindtap="changeAmount" data-change="-10">-</button>
              <input class="amount-input" type="number" value="{{selectedAmount}}" bindinput="onAmountInput" />
              <text class="amount-unit">g</text>
              <button class="portion-btn" bindtap="changeAmount" data-change="10">+</button>
            </view>
          </view>
          
          <view class="nutrition-table">
            <view class="nutrition-row header">
              <text class="nutrition-label">è¥å…»æˆåˆ†</text>
              <text class="nutrition-value">æ¯{{selectedAmount}}g</text>
            </view>
            <view class="nutrition-row">
              <text class="nutrition-label">çƒ­é‡</text>
              <text class="nutrition-value calories">{{calculatedNutrition.calories}} kcal</text>
            </view>
            <view class="nutrition-row">
              <text class="nutrition-label">è›‹ç™½è´¨</text>
              <text class="nutrition-value">{{calculatedNutrition.protein}} g</text>
            </view>
            <view class="nutrition-row">
              <text class="nutrition-label">ç¢³æ°´åŒ–åˆç‰©</text>
              <text class="nutrition-value">{{calculatedNutrition.carbs}} g</text>
            </view>
            <view class="nutrition-row">
              <text class="nutrition-label">è„‚è‚ª</text>
              <text class="nutrition-value">{{calculatedNutrition.fat}} g</text>
            </view>
            <view class="nutrition-row" wx:if="{{selectedFood.fiber}}">
              <text class="nutrition-label">è†€é£Ÿçº¤ç»´</text>
              <text class="nutrition-value">{{calculatedNutrition.fiber}} g</text>
            </view>
            <view class="nutrition-row" wx:if="{{selectedFood.sodium}}">
              <text class="nutrition-label">é’ </text>
              <text class="nutrition-value">{{calculatedNutrition.sodium}} mg</text>
            </view>
          </view>
          
          <view class="meal-selector">
            <text class="meal-label">æ·»åŠ åˆ°é¤æ¬¡</text>
            <view class="meal-options">
              <block wx:for="{{mealTypes}}" wx:key="type">
                <view class="meal-option {{selectedMeal === item.type ? 'active' : ''}}" bindtap="selectMeal" data-meal="{{item.type}}">
                  <text class="meal-icon">{{item.icon}}</text>
                  <text class="meal-name">{{item.name}}</text>
                </view>
              </block>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeFoodDetail">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="confirmAddFood">æ·»åŠ åˆ°{{getMealName(selectedMeal)}}</button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{searchKeyword && searchResults.length === 0 && !loading}}">
    <view class="empty-icon">ğŸ”</view>
    <text class="empty-text">æœªæ‰¾åˆ°ç›¸å…³é£Ÿç‰©</text>
    <text class="empty-hint">è¯•è¯•å…¶ä»–å…³é”®è¯æˆ–æ‰«ç æœç´¢</text>
    <button class="create-custom-btn" bindtap="createCustomFood">åˆ›å»ºè‡ªå®šä¹‰é£Ÿç‰©</button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text>æœç´¢ä¸­...</text>
  </view>
</view>